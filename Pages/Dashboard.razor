@page "/"
@using Microsoft.JSInterop
@using AppConcurso.Models
@using AppConcurso.Services
@inherits FlowbitePage
@inject CargoService CargoService
@inject CandidatoService CandidatoService
@inject InscricaoService InscricaoService

<PageTitle>Dashboard</PageTitle>

<div class="flex flex-col gap-4">
  <Header Title="Dashboard"
    Description="Ver de forma fácil e rápida os dados do sistema em forma de gráficos. Interaja e analise os dados de forma simples e prática." />

  <div class="flex flex-col flex-wrap lg:flex-row gap-4">
    <div
      class="bg-white rounded-lg w-[600px] shadow-sm dark:bg-gray-800 p-4 md:p-6 border-2 border-gray-200 dark:border-gray-700">
      <h5 class="text-xl mb-4 font-bold leading-none text-gray-900 dark:text-white pe-1">
        Candidatos Inscritos
      </h5>
      <div class="grid grid-cols-2">
        <dl class="flex items-center">
          <dt class="text-gray-500 dark:text-gray-400 text-sm font-normal me-1">Candidatos Inscritos:</dt>
          <dd class="text-gray-900 text-sm dark:text-white font-semibold">@Candidatos.Count</dd>
        </dl>
        <dl class="flex items-center">
          <dt class="text-gray-500 dark:text-gray-400 text-sm font-normal me-1">Cargos:</dt>
          <dd class="text-gray-900 text-sm dark:text-white font-semibold">@Cargos.Count</dd>
        </dl>
        <dl class="flex items-center">
          <dt class="text-gray-500 dark:text-gray-400 text-sm font-normal me-1">Inscrições:</dt>
          <dd class="text-gray-900 text-sm dark:text-white font-semibold">@Inscricoes.Count</dd>
        </dl>
      </div>
      <div class="mb-4 mt-2">
        <label for="selectCargoChart" class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Filtrar por
          Cargo:</label>
        <select id="selectCargoChart"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          <option value="">Todos os cargos</option>
          @for (int i = 0; i < Cargos.Count; i++)
          {
            <option value="@i">@Cargos[i].NomeCargo</option>
          }
        </select>
      </div>
      <div id="column-chart"></div>
    </div>

    <div
      class="bg-white rounded-lg w-[400px] flex flex-col justify-between shadow-sm dark:bg-gray-800 p-4 md:p-6 border-2 border-gray-200 dark:border-gray-700">
      <div class="flex justify-between mb-3">
        <div class="flex justify-center items-center">
          <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white pe-1">
            Cargos Inscritos
          </h5>
          <div data-popover id="chart-info" role="tooltip"
            class="absolute z-10 invisible inline-block text-sm text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-xs opacity-0 w-72 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400">
          </div>
        </div>
        <div>
          <button type="button" data-tooltip-target="data-tooltip" data-tooltip-placement="bottom"
            class="hidden sm:inline-flex items-center justify-center text-gray-500 w-8 h-8 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm">
            <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 16 18">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 1v11m0 0 4-4m-4 4L4 8m11 4v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3" />
            </svg>
            <span class="sr-only">Download data</span>
          </button>
          <div id="data-tooltip" role="tooltip"
            class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-gray-700">
            Download CSV
            <div class="tooltip-arrow" data-popper-arrow></div>
          </div>
        </div>
      </div>
      <!-- Donut Chart -->
      <div class="py-6" id="donut-chart"></div>
    </div>

    <div
      class="bg-white w-[400px] rounded-lg shadow-sm dark:bg-gray-800 p-4 md:p-6 border-2 border-gray-200 dark:border-gray-700 flex flex-col justify-between gap-4">
      <div class="flex justify-between items-start w-full">
        <div class="flex-col items-center">
          <div class="flex items-center mb-1">
            <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white me-1">
              Candidatos Inscritos
            </h5>
          </div>
        </div>
      </div>
      <!-- Line Chart -->
      <div class="py-6" id="pie-chart"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Use variáveis globais no window para evitar redeclaração
    window.chartColumn = window.chartColumn || null;
    window.chartDonut = window.chartDonut || null;
    window.chartPie = window.chartPie || null;
    window.allCargos = window.allCargos || [];
    window.allInscricoesPorCargo = window.allInscricoesPorCargo || [];
    window.donutLabels = window.donutLabels || [];
    window.donutSeries = window.donutSeries || [];
    window.pieLabels = window.pieLabels || [];
    window.pieSeries = window.pieSeries || [];

    window.initDataCharts = function (totalCandidatos, totalCargos, totalInscricoes, cargos, inscricoesPorCargo, donutLabelsParam, donutSeriesParam, pieLabelsParam, pieSeriesParam) {
      console.log('initDataCharts chamado', { totalCandidatos, totalCargos, totalInscricoes, cargos, inscricoesPorCargo });
      window.allCargos = cargos;
      window.allInscricoesPorCargo = inscricoesPorCargo;
      window.donutLabels = donutLabelsParam;
      window.donutSeries = donutSeriesParam;
      window.pieLabels = pieLabelsParam;
      window.pieSeries = pieSeriesParam;

      // Destroi gráficos antigos se existirem
      if (window.chartColumn) { window.chartColumn.destroy(); window.chartColumn = null; }
      if (window.chartDonut) { window.chartDonut.destroy(); window.chartDonut = null; }
      if (window.chartPie) { window.chartPie.destroy(); window.chartPie = null; }

      // Gráfico de barras
      if (typeof ApexCharts !== "undefined" && document.getElementById("column-chart")) {
        const optionsColumnChart = {
          colors: ["#1A56DB"],
          series: [
            {
              name: "Inscrições",
              color: "#1A56DB",
              data: cargos.map((cargo, idx) => ({ x: cargo, y: inscricoesPorCargo[idx] || 0 }))
            }
          ],
          chart: {
            type: "bar",
            height: "320px",
            fontFamily: "Inter, sans-serif",
            toolbar: {
              show: false,
            },
          },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: "70%",
              borderRadiusApplication: "end",
              borderRadius: 8,
            },
          },
          tooltip: {
            shared: true,
            intersect: false,
            style: {
              fontFamily: "Inter, sans-serif",
            },
          },
          states: {
            hover: {
              filter: {
                type: "darken",
                value: 1,
              },
            },
          },
          stroke: {
            show: true,
            width: 0,
            colors: ["transparent"],
          },
          grid: {
            show: false,
            strokeDashArray: 4,
            padding: {
              left: 2,
              right: 2,
              top: -14,
            },
          },
          dataLabels: {
            enabled: false,
          },
          legend: {
            show: false,
          },
          xaxis: {
            floating: false,
            labels: {
              show: true,
              style: {
                fontFamily: "Inter, sans-serif",
                cssClass: "text-xs font-normal fill-gray-500 dark:fill-gray-400",
              },
            },
            axisBorder: {
              show: false,
            },
            axisTicks: {
              show: false,
            },
          },
          yaxis: {
            show: false,
          },
          fill: {
            opacity: 1,
          },
        }
        window.chartColumn = new ApexCharts(document.getElementById("column-chart"), optionsColumnChart);
        window.chartColumn.render();
      }

      // Donut chart com dados reais
      if (typeof ApexCharts !== "undefined" && document.getElementById("donut-chart")) {
        const optionsDonut = {
          series: window.donutSeries,
          labels: window.donutLabels,
          colors: ["#1C64F2", "#16BDCA", "#FDBA8C", "#E74694", "#9061F9", "#F59E42", "#F43F5E"],
          chart: {
            height: 320,
            width: "100%",
            type: "donut",
          },
          stroke: {
            colors: ["transparent"],
            lineCap: "",
          },
          plotOptions: {
            pie: {
              donut: {
                labels: {
                  show: true,
                  name: {
                    show: true,
                    fontFamily: "Inter, sans-serif",
                    offsetY: 20,
                  },
                  total: {
                    showAlways: true,
                    show: true,
                    label: "Total",
                    fontFamily: "Inter, sans-serif",
                    formatter: function (w) {
                      const sum = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                      return sum;
                    },
                  },
                  value: {
                    show: true,
                    fontFamily: "Inter, sans-serif",
                    offsetY: -20,
                    formatter: function (value) {
                      return value;
                    },
                  },
                },
                size: "80%",
              },
            },
          },
          grid: {
            padding: {
              top: -2,
            },
          },
          dataLabels: {
            enabled: false,
          },
          legend: {
            position: "bottom",
            fontFamily: "Inter, sans-serif",
          },
        };
        window.chartDonut = new ApexCharts(document.getElementById("donut-chart"), optionsDonut);
        window.chartDonut.render();
      }

      // Pie chart com dados reais
      if (typeof ApexCharts !== "undefined" && document.getElementById("pie-chart")) {
        const optionsPie = {
          series: window.pieSeries,
          labels: window.pieLabels,
          colors: ["#1C64F2", "#16BDCA", "#9061F9", "#F59E42", "#F43F5E", "#FDBA8C", "#E74694"],
          chart: {
            height: 420,
            width: "100%",
            type: "pie",
          },
          stroke: {
            colors: ["white"],
            lineCap: "",
          },
          plotOptions: {
            pie: {
              labels: {
                show: true,
              },
              size: "100%",
              dataLabels: {
                offset: -25
              }
            },
          },
          dataLabels: {
            enabled: true,
            style: {
              fontFamily: "Inter, sans-serif",
            },
          },
          legend: {
            position: "bottom",
            fontFamily: "Inter, sans-serif",
          },
        };
        window.chartPie = new ApexCharts(document.getElementById("pie-chart"), optionsPie);
        window.chartPie.render();
      }

      // Evento para atualizar gráfico ao selecionar cargo
      const selectCargo = document.getElementById("selectCargoChart");
      if (selectCargo) {
        selectCargo.onchange = function () {
          const idx = selectCargo.value;
          let data;
          if (idx === "") {
            data = window.allCargos.map((cargo, i) => ({ x: cargo, y: window.allInscricoesPorCargo[i] || 0 }));
          } else {
            data = [{ x: window.allCargos[idx], y: window.allInscricoesPorCargo[idx] || 0 }];
          }
          if (window.chartColumn) {
            window.chartColumn.updateSeries([
              {
                name: "Inscrições",
                color: "#1A56DB",
                data: data
              }
            ]);
          }
        }
      }
    }
  });
</script>

@code {
  [Inject]
  public IJSRuntime JSRuntime { get; set; }

  public List<Cargo> Cargos { get; set; } = new();
  public List<Candidato> Candidatos { get; set; } = new();
  public List<Inscricao> Inscricoes { get; set; } = new();

  public Dictionary<string, int> InscricoesPorCargo =>
  Inscricoes
  .GroupBy(i => i.CargoId)
  .ToDictionary(
  g => Cargos.FirstOrDefault(c => c.Id == g.Key)?.NomeCargo ?? "Desconhecido",
  g => g.Count()
  );

  public string[] DonutLabels => InscricoesPorCargo.Keys.ToArray();
  public int[] DonutSeries => InscricoesPorCargo.Values.ToArray();

  public string[] PieLabels => InscricoesPorCargo.Keys.ToArray();
  public int[] PieSeries => InscricoesPorCargo.Values.ToArray();

  protected override async Task OnInitializedAsync()
  {
    Cargos = await CargoService.GetCargos();
    Candidatos = await CandidatoService.GetCandidatos();
    Inscricoes = await InscricaoService.GetInscricoes();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    await JSRuntime.InvokeVoidAsync("initDataCharts",
    Candidatos.Count,
    Cargos.Count,
    Inscricoes.Count,
    Cargos.Select(c => c.NomeCargo).ToArray(),
    InscricoesPorCargo.Values.ToArray(),
    DonutLabels,
    DonutSeries,
    PieLabels,
    PieSeries
    );

  }
}
