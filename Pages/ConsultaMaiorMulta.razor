@page "/consulta-maior-multa"
@using LearningBlazor.Models;
@using LearningBlazor.Services;
@inject VeiculoController veiculoController;
@inject MultaController multaController;
@inject NavigationManager navegacao;

<h3>CONSULTA DE MAIOR MULTA</h3>

<div class="container">
  <nav class="navbar navbar-light" style="background-color: white"></nav>

  <nav class="navbar navbar-light" style="background-color: darkgreen"></nav>

  <label for="veiculo" class="form-label">CARROS CADASTRADOS:</label>
  <select class="form-select" aria-label="Selecione um carro" @onchange="SelecionarVeiculo">
    <option selected>Selecione uma placa</option>
    @foreach (var item in listaVeiculos)
    {
      <option value=@item.Id>@item.Modelo</option>
    }
  </select>

  <nav class="navbar navbar-light" style="background-color: white"></nav>

  <nav class="navbar navbar-light" style="background-color: darkgreen"></nav>

  <div class="mb-3">
    <label for="exampleFormControlInput1" class="form-label">MODELO:</label>
    <input @bind="@veiculo.Modelo" type="text" class="form-control" id="exampleFormControlInput1"
      disable="@campoBloqueado">
  </div>

  <div class="mb-3">
    <label for="exampleFormControlInput1" class="form-label">MARCA:</label>
    <input @bind="@veiculo.Marca" type="text" class="form-control" id="exampleFormControlInput1"
      disable="@campoBloqueado">
  </div>

  <div class="mb-3">
    <label for="exampleFormControlInput1" class="form-label">PLACA:</label>
    <input @bind="@veiculo.Placa" type="text" class="form-control" id="exampleFormControlInput1"
      disable="@campoBloqueado">
  </div>
  <nav class="navbar navbar-light" style="background-color: white"></nav>

  <nav class="navbar navbar-light" style="background-color: darkgreen"></nav>

  <nav class="navbar navbar-light" style="background-color: white"></nav>


  <button type="button" class="btn btn-warning" @onclick="Cancelar">CANCELAR</button>

  <nav class="navbar navbar-light" style="background-color: white"></nav>

  <nav class="navbar navbar-light" style="background-color: darkgreen"></nav>

  <nav class="navbar navbar-light" style="background-color: white"></nav>



  <table class="table">
    <thead>
      <tr>
        <th>Descrição:</th>
        <th>Valor:</th>
      </tr>
    </thead>
    <tbody>
      @if (Descricao != null && Valor != null)
      {
        <tr>
          <td>@Descricao</td>
          <td>R$ @FormatValue(@Valor!.Value)</td>
        </tr>
      }
    </tbody>
  </table>

  @if (listaMultas.Count > 0)
  {
    <nav class="navbar navbar-light" style="background-color: darkorange"></nav>
    <h4>Total: R$ @FormatValue(@valorTotal)</h4>
    <nav class="navbar navbar-light" style="background-color: darkorange"></nav>
  }
</div>


@code {
  List<Veiculo> listaVeiculos = new List<Veiculo>();
  List<Multa> listaMultas = new List<Multa>();

  Veiculo veiculo = new Veiculo();
  private bool campoBloqueado = true;

  private decimal valorTotal => listaMultas.Sum(x => x.ValorMulta.Value);

  private string? Descricao { get; set; } = null;
  private decimal? Valor { get; set; } = null;

  protected override async Task OnInitializedAsync()
  {
    listaVeiculos = await veiculoController.GetVeiculos();
  }

  private void SelecionarVeiculo(ChangeEventArgs e)
  {
    var id = Convert.ToInt32(e.Value);
    veiculo = listaVeiculos.FirstOrDefault(x => x.Id == id);
    listaMultas = veiculo.Multas.ToList();

    Descricao = listaMultas.OrderByDescending(x => x.ValorMulta).FirstOrDefault().Descricao;
    Valor = listaMultas.OrderByDescending(x => x.ValorMulta).FirstOrDefault().ValorMulta.Value;
  }

  private void NovoRegistro()
  {
    veiculo = new Veiculo();
    listaMultas = new List<Multa>();
    campoBloqueado = true;
    Descricao = null;
    Valor = null;
  }

  private void Cancelar()
  {
    NovoRegistro();
  }

  private string FormatValue(decimal value)
  {
    return value.ToString("N2");
  }
}